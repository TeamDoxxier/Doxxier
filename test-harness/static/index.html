<!DOCTYPE html>
<html lang="en">
<head>
    <title>My Website</title>
    <script src="/assets/wasm_exec.js"></script>
    <script>
        const go = new Go();
        WebAssembly.instantiateStreaming(fetch('/assets/doxxier.wasm'), go.importObject).then(result => {
            go.run(result.instance);
        }).catch(console.error);

        async function uploadFile() {
            var file = document.getElementById('file').files[0];
            console.log(file);
            getFileBytes(file).then(bytes => {
                var result = window.compress("AlgXz", bytes)
                base64Img = uint8ArrayToBase64(result);
                console.log(base64Img);
                document.getElementById('img').src = 'data:image/jpeg;base64,' + base64Img
            });
        }

        async function transform(){
            var file = document.getElementById('file').files[0]
            getFileBytes(file).then(bytes =>{
                var result = window.transformImage(bytes)
                const blob = new Blob([result], { type: 'image/avif' });
                const url = URL.createObjectURL(blob);
                document.getElementById("img").src = url
            })
        }

        function uint8ArrayToBase64(uint8Array) {
            // Convert Uint8Array to a string
            const binaryString = new TextDecoder().decode(uint8Array);
            
            // Encode the string to Base64
            return btoa(binaryString);
        }

        function getFileBytes(file) {
            return new Promise((resolve, reject) => {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var buffer = e.target.result;
                    var bytes = new Uint8Array(buffer);
                    resolve(bytes)
                };
                reader.readAsArrayBuffer(file);
            });
        }
    </script>
</head>
<body>
    <form id="main">
        <span>Select a file</span>
        <input type="file" id="file" name="file">
        <button type="button" onclick="transform()">Compress</button>
    </form>
    <span>Compression status: <span id="status"></span></span>
    <img id="img" src="" alt="Compressed image">
</body>
</html>